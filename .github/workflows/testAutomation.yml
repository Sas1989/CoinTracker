name: "Create cluster using KinD"
on: [push]

jobs:
  kind:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Set up Kubernetes CLI
      uses: azure/setup-kubectl@v1
      
    - name: Deploy app to Kubernetes
      run: |
        cd k8s
        kubectl apply -f rabbitmq-depl.yaml
        kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.5.1/deploy/static/provider/cloud/deploy.yaml
        kubectl delete -A ValidatingWebhookConfiguration ingress-nginx-admission
        kubectl apply -f ingress.yaml
        kubectl apply -f local-pvc.yaml
        kubectl apply -f cointrackercoin-depL.yaml
    - name: Wait service up
      run: | 
        kubectl rollout status deployment/cointracker-api-coinlist-depl
        kubectl get services
        kubectl get nodes -o=jsonpath='{.items[0].status.addresses[0].address}'
        kubectl get services cointracker-api-coinlist -o=jsonpath='{.spec.ports[0].targetPort}'
    - name: Test Api
      run: |
        NODE_PORT=$(kubectl get services cointracker-api-coinlist -o=jsonpath='{.spec.ports[0].targetPort}')
        NODE_IP=$(kubectl get nodes -o=jsonpath='{.items[0].status.addresses[0].address}')
        echo "http://$NODE_IP:$NODE_PORT/api/coin"
        curl -I http://$NODE_IP:$NODE_PORT/api/coin
    - name: Delete Kunbernetes cluster
      run: |
        kind delete cluster
